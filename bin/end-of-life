#!/usr/bin/env php
<?php

/*
 * PHP End of Life CLI
 * Expose PHP EOL Date and Check if Version is Supported
 *
 * Usage:
 *   end-of-life
 *   end-of-life 1.0.0
 *   end-of-life help
 *
 * Return:
 *     0 Success
 *     1 Unsupported Version
 *     2 Invalid Arguments
 *   254 Unknown Autoload Location
 */

use Cyrosy\PhpEndOfLife\PhpEndOfLife;

$locations = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../vendor/autoload.php',
];

$loaded = false;

foreach ($locations as $location) {
    if (is_file($location)) {
        require_once($location);
        $loaded = true;
        break;
    }
}

if (! $loaded) {
    fwrite(STDERR, 'Unknown Autoload Location');
    exit(254);
}

function printPhpEndOfLifeHelp($command)
{
    fwrite(STDERR,
        "PHP End of Life\n"
        . "Expose PHP EOL Date and Check if Version is Supported\n\n"
        . "Usage:\n"
        . ' ' . $command . "\n"
        . ' ' . $command . " 1.0.0\n"
        . ' ' . $command . " help\n"
    );

    return 2;
}

function printPhpEndOfLifeError($exception)
{
    fwrite(STDERR, $exception->getMessage() . "\n");

    return 2;
}

$version = phpversion();

if ($argc > 2) {
    exit(printPhpEndOfLifeHelp($argv[0]));
}

$version = phpversion();

if ($argc === 2) {
    if ($argv[1] === 'help') {
        printPhpEndOfLifeHelp($argv[0]);
        exit(0);
    }

    $version = $argv[1];
}

try {
    if (! PhpEndOfLife::isSupported($version)) {
        // Unsupported
        exit(1);
    }
    // Success!
    exit(0);
} catch (Exception $e) {
    exit(printPhpEndOfLifeError($e));
}
